<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¬é˜ªäº’å‹•è³¼ç‰©æ¸…å–®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F9F8F6; /* Slightly warmer background */
            color: #4A4543;
        }
        .active-filter {
            background-color: #7B6D64 !important;
            color: #FFFFFF !important;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .filter-btn {
            transition: all 0.3s ease;
        }
        .location-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #EAE4E0;
        }
        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .item-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .item-list.open {
            max-height: 1000px; /* Increased max-height for longer lists */
        }
        .checklist-item input[type="checkbox"]:checked + label {
            text-decoration: line-through;
            color: #a0aec0;
        }
        .checklist-item input[type="checkbox"] {
            accent-color: #A59487;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 280px;
        }
        #map { 
            height: 500px; 
            width: 100%;
            border-radius: 1rem; /* Rounded corners for the map */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
        }
        .leaflet-popup-content {
            font-family: 'Noto Sans TC', sans-serif;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 320px;
            }
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-[#6A5F5D]">äº¬é˜ª8æ—¥éŠ äº’å‹•è³¼ç‰©æ¸…å–® (2024-2025æ›´æ–°ç‰ˆ)</h1>
            <p class="mt-2 text-lg text-gray-600">æ‚¨çš„å€‹äººåŒ–äº¬é˜ªè³¼ç‰©èˆ‡ç¾é£ŸåŠ©ç†</p>
        </header>

        <nav class="bg-white/80 backdrop-blur-sm rounded-xl shadow-md p-4 sticky top-4 z-10 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="w-full md:w-auto">
                    <p class="font-bold text-gray-700 mb-2 text-center md:text-left">ä¸»è¦åˆ†é¡</p>
                    <div id="category-filters" class="flex justify-center space-x-2 bg-gray-200 p-1 rounded-lg">
                        <button data-filter="take-home" class="filter-btn w-full md:w-auto px-4 py-2 text-sm font-semibold rounded-md text-gray-700 active-filter">ğŸ å¯å¸¶å›åœ‹</button>
                        <button data-filter="dine-in" class="filter-btn w-full md:w-auto px-4 py-2 text-sm font-semibold rounded-md text-gray-700">ğŸœ åœ¨åœ°å“åš</button>
                    </div>
                </div>
                <div class="w-full md:w-auto">
                    <p class="font-bold text-gray-700 mb-2 text-center md:text-left">åœ°å€ç¯©é¸</p>
                    <div id="city-filters" class="flex justify-center space-x-2 bg-gray-200 p-1 rounded-lg">
                        <button data-filter="all" class="filter-btn w-full md:w-auto px-4 py-2 text-sm font-semibold rounded-md text-gray-700 active-filter">å…¨éƒ¨</button>
                        <button data-filter="kyoto" class="filter-btn w-full md:w-auto px-4 py-2 text-sm font-semibold rounded-md text-gray-700">äº¬éƒ½</button>
                        <button data-filter="osaka" class="filter-btn w-full md:w-auto px-4 py-2 text-sm font-semibold rounded-md text-gray-700">å¤§é˜ª</button>
                    </div>
                </div>
            </div>
        </nav>
        
        <section id="charts-section" class="mb-12">
            <h2 class="text-2xl font-bold text-center mb-6 text-[#6A5F5D]">è³¼ç‰©é¡å‹åˆ†æ</h2>
            <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto">é€™ä»½åœ–è¡¨åˆ†æäº†ã€Œå¯å¸¶å›åœ‹ã€çš„ä¼´æ‰‹ç¦®é¡å‹ã€‚äº¬éƒ½ä»¥å‚³çµ±ç”œé»å’Œç²¾ç·»é›œè²¨è¦‹é•·ï¼Œè€Œå¤§é˜ªå‰‡åœ¨æµè¡Œæ–‡åŒ–å‘¨é‚Šå’Œå‰µæ„é›¶é£Ÿä¸Šå±•ç¾æ´»åŠ›ã€‚é€™èƒ½å¹«åŠ©æ‚¨å¿«é€ŸæŒæ¡å…©åœ°çš„è³¼ç‰©ç‰¹è‰²ï¼Œè¦åŠƒæ‚¨çš„æ¡è³¼é‡é»ã€‚</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-center mb-4">äº¬éƒ½ä¼´æ‰‹ç¦®åˆ†ä½ˆ</h3>
                    <div class="chart-container mx-auto max-w-md">
                        <canvas id="kyoto-chart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-center mb-4">å¤§é˜ªä¼´æ‰‹ç¦®åˆ†ä½ˆ</h3>
                    <div class="chart-container mx-auto max-w-md">
                        <canvas id="osaka-chart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <main id="item-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Shopping items will be rendered here by JavaScript -->
        </main>

        <section id="map-section" class="mt-12">
            <h2 class="text-2xl font-bold text-center mb-6 text-[#6A5F5D]">ç›¸é—œä½ç½®åœ°åœ–</h2>
            <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto">é€™å¼µåœ°åœ–æ¨™ç¤ºäº†æ¸…å–®ä¸­æåˆ°çš„ä¸»è¦è³¼ç‰©åœ°é»å’Œç¾é£Ÿå€ã€‚æ‚¨å¯ä»¥é»æ“Šåœ°åœ–ä¸Šçš„æ¨™è¨˜æŸ¥çœ‹åœ°é»åç¨±ï¼Œæ–¹ä¾¿æ‚¨è¦åŠƒè·¯ç·šã€‚</p>
            <div id="map"></div>
        </section>

    </div>

    <script>
        // --- DATA (Updated for 2024-2025) ---
        const shoppingData = {
            'take-home': {
                'kyoto': [
                    {
                        location: "äº¬éƒ½è»Šç«™",
                        icon: "ğŸš‰",
                        coords: [34.9858, 135.7588],
                        items: [
                            { name: "èŒ¶ä¹‹è“ (MALEBRANCHE)", type: "ç”œé»" },
                            { name: "ä¸­æ‘è—¤å‰ (æŠ¹èŒ¶ç”œé»åŠèŒ¶è‘‰)", type: "ç”œé»" },
                            { name: "PRESS BUTTER SAND (å¥¶æ²¹å¤¾å¿ƒé¤…)", type: "ç”œé»" },
                            { name: "äº¬éƒ½ç¥‡åœ’ã‚ã®ã‚“ (Anone) éº»ç³¬æœ€ä¸­", type: "ç”œé»" },
                            { name: "ä¼Šå‹¢ä¸¹ç™¾è²¨åœ°ä¸‹è¡—ä¼´æ‰‹ç¦®", type: "ç¶œåˆ" },
                        ]
                    },
                    {
                        location: "éŒ¦å¸‚å ´",
                        icon: "ğŸ¥•",
                        coords: [35.0050, 135.7640],
                        items: [
                            { name: "äº¬æ¼¬ç‰© (å„å¼é†ƒèœ)", type: "é¹¹é£Ÿ" },
                            { name: "SNOOPYèŒ¶å±‹å‘¨é‚Šå•†å“", type: "å‹•æ¼«/è§’è‰²" },
                            { name: "æœ‰æ¬¡ (Aritsugu) çš„å»šåˆ€", type: "é›œè²¨" },
                            { name: "äº¬ä¸¹æ³¢ (çƒ¤æ —å­)", type: "ç”œé»" },
                        ]
                    },
                    {
                        location: "å››æ¡æ²³åŸç”º",
                        icon: "ğŸ¬",
                        coords: [35.0045, 135.7681],
                        items: [
                            { name: "é«˜å³¶å±‹ã€äº¬éƒ½BALã€å¤§ä¸¸ç™¾è²¨", type: "ç¶œåˆ" },
                            { name: "LOFTã€æ·³ä¹…å ‚æ›¸åº—", type: "é›œè²¨" },
                            { name: "Disney Store æ——è‰¦åº—", type: "å‹•æ¼«/è§’è‰²" },
                            { name: "Good Nature Station (å¤©ç„¶æœ‰æ©Ÿå•†å“)", type: "é›œè²¨" },
                        ]
                    },
                    {
                        location: "æ–°äº¬æ¥µãƒ»å¯ºç”ºäº¬æ¥µ",
                        icon: "ğŸ›ï¸",
                        coords: [35.0068, 135.7671],
                        items: [
                            { name: "è—¥å¦ (å¤§åœ‹ã€æ¾æœ¬æ¸…ã€SUNDRUG)", type: "è—¥å¦" },
                            { name: "WEGOã€GU æ½®æµæœé£¾", type: "æœé£¾" },
                            { name: "é³©å±…å ‚çš„æ–‡å…·ã€ç·šé¦™", type: "é›œè²¨" },
                            { name: "#C-plaã€GASHAPONä¹‹æ£® (æ‰­è›‹)", type: "å‹•æ¼«/è§’è‰²" },
                        ]
                    },
                    {
                        location: "æ±å±± (æ¸…æ°´å¯ºå‘¨é‚Š)",
                        icon: "ğŸ®",
                        coords: [34.9949, 135.7850],
                        items: [
                            { name: "ã‚ˆãƒ¼ã˜ã‚„ (Yojiya) çš„å¸æ²¹é¢ç´™/ç¾å¦", type: "è—¥å¦" },
                            { name: "ç”Ÿå…«æ©‹ (è–è­·é™¢ã€è¥¿å°¾)", type: "ç”œé»" },
                            { name: "ä¸ƒå‘³å®¶æœ¬èˆ–çš„ä¸ƒå‘³ç²‰", type: "é¹¹é£Ÿ" },
                            { name: "äº¬éƒ½åŒ—å±± (èŒ¶ä¹‹è“) æ¸…æ°´å‚åº—", type: "ç”œé»" },
                        ]
                    }
                ],
                'osaka': [
                    {
                        location: "æ—¥æœ¬æ©‹é›»é›»åŸ",
                        icon: "ğŸ®",
                        coords: [34.6625, 135.5060],
                        items: [
                            { name: "Animateã€K-BOOKS å‹•æ¼«å•†å“", type: "å‹•æ¼«/è§’è‰²" },
                            { name: "Joshin Super Kids Land æ¨¡å‹", type: "å‹•æ¼«/è§’è‰²" },
                            { name: "Super Potatoã€é§¿æ²³å±‹ æ‡·èˆŠé›»ç©", type: "å‹•æ¼«/è§’è‰²" },
                            { name: "å„å¼æ‰­è›‹åº—ã€ä¸€ç•ªè³", type: "å‹•æ¼«/è§’è‰²" },
                        ]
                    },
                    {
                        location: "å¿ƒé½‹æ©‹ãƒ»é“é “å €",
                        icon: "ğŸ’–",
                        coords: [34.6687, 135.5013],
                        items: [
                            { name: "å¤§ä¸¸ã€PARCO ç™¾è²¨ (6Fä»»å¤©å ‚/å¡æ™®ç©º)", type: "ç¶œåˆ" },
                            { name: "Sanrio Gallery (ä¸‰éº—é·—å°ˆè³£åº—)", type: "å‹•æ¼«/è§’è‰²" },
                            { name: "å›ºåŠ›æœå±‹ (Glico-ya) é™å®šé›¶é£Ÿ", type: "é›¶é£Ÿ" },
                            { name: "å”å‰è¨¶å¾· (é“é “å €åº—/å¾¡å ‚ç­‹åº—)", type: "ç¶œåˆ" },
                            { name: "æ¾æœ¬æ¸…ã€å¤§åœ‹è—¥å¦", type: "è—¥å¦" },
                        ]
                    },
                    {
                        location: "æ¢…ç”°",
                        icon: "ğŸ™ï¸",
                        coords: [34.7025, 135.4959],
                        items: [
                            { name: "é˜ªæ€¥/é˜ªç¥/å¤§ä¸¸ç™¾è²¨", type: "ç¶œåˆ" },
                            { name: "LUCUA / Grand Front Osaka", type: "ç¶œåˆ" },
                            { name: "KIDDY LAND (è§’è‰²å•†å“)", type: "å‹•æ¼«/è§’è‰²" },
                            { name: "Yodobashi Camera é›»å™¨", type: "é›»å™¨" },
                            { name: "BÃ¢ton d'or (é«˜ç´šPocky)", type: "ç”œé»" },
                        ]
                    },
                    {
                        location: "ç’°çƒå½±åŸ (USJ)",
                        icon: "ğŸ¢",
                        coords: [34.6656, 135.4325],
                        items: [
                            { name: "è¶…ç´šä»»å¤©å ‚ä¸–ç•Œèƒ½é‡æ‰‹ç’°", type: "å‹•æ¼«/è§’è‰²" },
                            { name: "å“ˆåˆ©æ³¢ç‰¹é­”æ³•ä¸–ç•Œé­”æ–", type: "å‹•æ¼«/è§’è‰²" },
                            { name: "åœ’å€å…§é™å®šçš„å„å¼ç¦®å“", type: "å‹•æ¼«/è§’è‰²" },
                        ]
                    },
                    {
                        location: "é—œè¥¿æ©Ÿå ´",
                        icon: "âœˆï¸",
                        coords: [34.4343, 135.2444],
                        items: [
                            { name: "Royce' å·§å…‹åŠ›", type: "ç”œé»" },
                            { name: "ç™½è‰²æˆ€äºº (Shiroi Koibito)", type: "ç”œé»" },
                            { name: "æ±äº¬é¦™è•‰ (Tokyo Banana)", type: "ç”œé»" },
                            { name: "Sugar Butter Tree å¤¾å¿ƒé¤…", type: "ç”œé»" },
                        ]
                    }
                ]
            },
            'dine-in': {
                'kyoto': [
                    {
                        location: "äº¬éƒ½è»Šç«™",
                        icon: "ğŸš‰",
                        coords: [34.9858, 135.7588],
                        items: [
                            { name: "äº¬éƒ½æ‹‰éººå°è·¯ (æ¨è–¦ã¾ã™ãŸã«)", type: "æ‹‰éºµ" },
                            { name: "åä»£è±¬æ’ (ã‹ã¤ãã‚‰)", type: "æ—¥å¼" },
                            { name: "æ±æ´‹äº­æ¼¢å ¡æ’", type: "æ´‹é£Ÿ" },
                            { name: "ã¯ã—ãŸã¦ (å’Œä¹…å‚³ç³»åˆ—)", type: "æ—¥å¼" },
                        ]
                    },
                    {
                        location: "éŒ¦å¸‚å ´",
                        icon: "ğŸ¥•",
                        coords: [35.0050, 135.7640],
                        items: [
                            { name: "ä¸‰æœ¨é›åµ (ç‰å­ç‡’)", type: "å°åƒ" },
                            { name: "é®®é­šæœ¨æ‘ (ç”Ÿé­šç‰‡ä¸²)", type: "å°åƒ" },
                            { name: "ã“ã‚“ãªã‚‚ã‚“ã˜ã‚ƒ (è±†ä¹³ç”œç”œåœˆ/å†°æ·‡æ·‹)", type: "å°åƒ" },
                        ]
                    },
                    {
                        location: "åµå±±",
                        icon: "ï¿½",
                        coords: [35.0160, 135.6740],
                        items: [
                            { name: "åµå±±ã‚ˆã—ã‚€ã‚‰ (è•éº¥éºµ)", type: "æ—¥å¼" },
                            { name: "é¯›åŒ HANANA (é¯›é­šèŒ¶æ³¡é£¯)", type: "æ—¥å¼" },
                            { name: "% ARABICA å’–å•¡", type: "å’–å•¡" },
                            { name: "å¤éƒ½èŠ‹æœ¬èˆ– (å†°æ·‡æ·‹)", type: "ç”œé»" },
                        ]
                    },
                    {
                        location: "ç¥‡åœ’ãƒ»æ²³åŸç”º",
                        icon: "ğŸŒ¸",
                        coords: [35.0039, 135.7720],
                        items: [
                            { name: "èŒ¶å¯®éƒ½è·¯é‡Œ (æŠ¹èŒ¶è–ä»£)", type: "ç”œé»" },
                            { name: "å£¹éŒ¢æ´‹é£Ÿ (å¤æ—©å‘³å¤§é˜ªç‡’)", type: "å°åƒ" },
                            { name: "Red Rock (çƒ¤ç‰›è‚‰ä¸¼)", type: "ä¸¼é£¯" },
                            { name: "INODA COFFEE (å’–å•¡å»³)", type: "å’–å•¡" },
                        ]
                    }
                ],
                'osaka': [
                    {
                        location: "é»‘é–€å¸‚å ´",
                        icon: "ğŸŸ",
                        coords: [34.6649, 135.5065],
                        items: [
                            { name: "ã¾ãã‚ã‚„é»’éŠ€ (é®ªé­šå°ˆè³£)", type: "æµ·é®®" },
                            { name: "è¥¿å·é®®é­šåº— (ç¾çƒ¤æµ·é®®)", type: "æµ·é®®" },
                            { name: "ä¸¸å–„é£Ÿè‚‰åº— (ç¥æˆ¶ç‰›)", type: "å’Œç‰›" },
                            { name: "é«˜æ©‹é£Ÿå“ (è±†æ¼¿)", type: "é£²å“" },
                        ]
                    },
                    {
                        location: "é“é “å €",
                        icon: "ğŸ¦€",
                        coords: [34.6687, 135.5013],
                        items: [
                            { name: "ã‹ã«é“æ¥½ (èƒèŸ¹æ–™ç†)", type: "æµ·é®®" },
                            { name: "ç¾æ´¥ã® (ç±³å…¶æ—æ¨è–¦å¤§é˜ªç‡’)", type: "å¤§é˜ªç‡’" },
                            { name: "ã‚ã£ã¡ã¡æœ¬èˆ— æˆ– ããã‚‹ (ç« é­šç‡’)", type: "å°åƒ" },
                            { name: "é‡‘é¾ æˆ– ä¸€è˜­ (æ‹‰éºµ)", type: "æ‹‰éºµ" },
                            { name: "ã ã‚‹ã¾ (é”æ‘©) ä¸²ç‚¸", type: "ä¸²ç‚¸" },
                        ]
                    },
                    {
                        location: "æ¢…ç”°",
                        icon: "ğŸ™ï¸",
                        coords: [34.7025, 135.4959],
                        items: [
                            { name: "ãã˜ (å¤§é˜ªç‡’)", type: "å¤§é˜ªç‡’" },
                            { name: "HARBS (æ°´æœåƒå±¤è›‹ç³•)", type: "ç”œé»" },
                            { name: "åˆ©ä¹…ç‰›èˆŒ", type: "æ—¥å¼" },
                        ]
                    }
                ]
            }
        };

        // --- GLOBAL VARIABLES ---
        let currentCategory = 'take-home';
        let currentCity = 'all';
        let kyotoChart, osakaChart, map;
        let appData; // Use a mutable data object

        // --- DOM ELEMENTS ---
        const itemGrid = document.getElementById('item-grid');
        const categoryFilters = document.getElementById('category-filters');
        const cityFilters = document.getElementById('city-filters');
        const chartsSection = document.getElementById('charts-section');

        // --- FUNCTIONS ---

        /**
         * Load data from localStorage or use initial data
         */
        function loadData() {
            const savedData = localStorage.getItem('shoppingData');
            appData = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(shoppingData));
        }

        /**
         * Save data to localStorage
         */
        function saveData() {
            localStorage.setItem('shoppingData', JSON.stringify(appData));
        }

        /**
         * Renders the location cards based on current filters
         */
        function renderCards() {
            itemGrid.innerHTML = '';
            let dataToShow = [];
            let originalIndices = [];

            if (currentCity === 'all') {
                const kyotoData = appData[currentCategory]['kyoto'] || [];
                const osakaData = appData[currentCategory]['osaka'] || [];
                dataToShow = [...kyotoData, ...osakaData];
                originalIndices = [
                    ...kyotoData.map((_, i) => ({ city: 'kyoto', index: i })),
                    ...osakaData.map((_, i) => ({ city: 'osaka', index: i }))
                ];
            } else {
                dataToShow = appData[currentCategory][currentCity] || [];
                originalIndices = dataToShow.map((_, i) => ({ city: currentCity, index: i }));
            }
            
            if (dataToShow.length === 0) {
                itemGrid.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">æ­¤åˆ†é¡ä¸‹æ²’æœ‰é …ç›®ã€‚</p>`;
                return;
            }

            dataToShow.forEach((location, i) => {
                const { city, index } = originalIndices[i];
                const card = document.createElement('div');
                card.className = 'location-card bg-white rounded-xl shadow-md overflow-hidden';
                card.dataset.city = city;
                card.dataset.index = index;

                card.innerHTML = `
                    <div class="p-4 bg-gray-50 border-b flex items-center justify-between cursor-pointer" data-action="toggle">
                        <h3 class="text-xl font-bold text-gray-800">${location.icon} ${location.location}</h3>
                        <span class="text-gray-400 transform transition-transform duration-300">â–¼</span>
                    </div>
                    <div class="item-list p-4 bg-white">
                        <ul class="space-y-3">
                            ${location.items.map((item, itemIndex) => `
                                <li class="checklist-item flex items-center group" data-item-index="${itemIndex}">
                                    <input type="checkbox" id="item-${city}-${index}-${itemIndex}" class="mr-3 h-4 w-4 rounded border-gray-300 focus:ring-0" ${item.checked ? 'checked' : ''}>
                                    <label for="item-${city}-${index}-${itemIndex}" class="text-gray-700 flex-grow">${item.name} ${item.type ? `<span class='text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full'>${item.type}</span>` : ''}</label>
                                    <button data-action="edit" class="p-1 text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity">âœï¸</button>
                                    <button data-action="delete" class="p-1 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity">ğŸ—‘ï¸</button>
                                </li>
                            `).join('')}
                        </ul>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <input type="text" placeholder="æ–°å¢å“é …åç¨±..." class="border-gray-300 rounded-md shadow-sm text-sm p-2 focus:ring-A59487 focus:border-A59487" data-input="name">
                                <input type="text" placeholder="å“é …é¡åˆ¥ (å¯é¸)" class="border-gray-300 rounded-md shadow-sm text-sm p-2 focus:ring-A59487 focus:border-A59487" data-input="type">
                            </div>
                            <button data-action="add" class="mt-2 w-full bg-[#A59487] text-white px-4 py-2 rounded-md hover:bg-[#7B6D64] text-sm font-semibold">æ–°å¢å“é …</button>
                        </div>
                    </div>
                `;
                itemGrid.appendChild(card);
            });
        }

        /**
         * Updates the visual state of filter buttons
         */
        function updateFilterButtons() {
            Array.from(categoryFilters.children).forEach(btn => {
                btn.classList.toggle('active-filter', btn.dataset.filter === currentCategory);
            });
            Array.from(cityFilters.children).forEach(btn => {
                btn.classList.toggle('active-filter', btn.dataset.filter === currentCity);
            });
            
            chartsSection.style.display = currentCategory === 'take-home' ? 'block' : 'none';
        }

        /**
         * Creates or updates the doughnut charts
         */
        function createOrUpdateCharts() {
            const chartColors = ['#A59487', '#B9A99D', '#D3C9C1', '#6A5F5D', '#9E8A7E'];

            function prepareChartData(city) {
                const typeCounts = {};
                appData['take-home'][city].forEach(location => {
                    location.items.forEach(item => {
                        const type = item.type || 'å…¶ä»–';
                        typeCounts[type] = (typeCounts[type] || 0) + 1;
                    });
                });
                return {
                    labels: Object.keys(typeCounts),
                    data: Object.values(typeCounts),
                };
            }

            const kyotoChartData = prepareChartData('kyoto');
            const osakaChartData = prepareChartData('osaka');

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { family: "'Noto Sans TC', sans-serif" }
                        }
                    },
                    tooltip: {
                        bodyFont: { family: "'Noto Sans TC', sans-serif" },
                        titleFont: { family: "'Noto Sans TC', sans-serif" }
                    }
                }
            };

            // Destroy existing charts if they exist
            if (kyotoChart) kyotoChart.destroy();
            if (osakaChart) osakaChart.destroy();

            kyotoChart = new Chart(document.getElementById('kyoto-chart'), {
                type: 'doughnut',
                data: {
                    labels: kyotoChartData.labels,
                    datasets: [{
                        label: 'ä¼´æ‰‹ç¦®é¡å‹',
                        data: kyotoChartData.data,
                        backgroundColor: chartColors,
                        borderColor: '#F9F8F6',
                        borderWidth: 3
                    }]
                },
                options: chartOptions
            });

            osakaChart = new Chart(document.getElementById('osaka-chart'), {
                type: 'doughnut',
                data: {
                    labels: osakaChartData.labels,
                    datasets: [{
                        label: 'ä¼´æ‰‹ç¦®é¡å‹',
                        data: osakaChartData.data,
                        backgroundColor: chartColors,
                        borderColor: '#F9F8F6',
                        borderWidth: 3
                    }]
                },
                options: chartOptions
            });
        }

        /**
         * Initializes the Leaflet map and adds markers
         */
        function initializeMap() {
            if (map) return; // Initialize map only once

            map = L.map('map').setView([34.8, 135.6], 9); // Centered between Kyoto and Osaka

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            const allLocations = [...shoppingData['take-home']['kyoto'], ...shoppingData['take-home']['osaka'], ...shoppingData['dine-in']['kyoto'], ...shoppingData['dine-in']['osaka']];
            
            const uniqueLocations = allLocations.reduce((acc, current) => {
                if (!acc.find(item => item.location === current.location)) {
                    acc.push(current);
                }
                return acc;
            }, []);

            uniqueLocations.forEach(loc => {
                if(loc.coords) {
                    L.marker(loc.coords).addTo(map)
                        .bindPopup(`<b>${loc.icon} ${loc.location}</b>`);
                }
            });
        }
        
        // --- EVENT LISTENERS ---
        categoryFilters.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.filter !== currentCategory) {
                currentCategory = e.target.dataset.filter;
                renderCards();
                updateFilterButtons();
            }
        });

        cityFilters.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && e.target.dataset.filter !== currentCity) {
                currentCity = e.target.dataset.filter;
                renderCards();
                updateFilterButtons();
            }
        });

        itemGrid.addEventListener('click', (e) => {
            const target = e.target;
            const card = target.closest('.location-card');
            if (!card) return;

            const city = card.dataset.city;
            const locationIndex = parseInt(card.dataset.index);
            const action = target.dataset.action || target.parentElement.dataset.action;

            if (action === 'toggle') {
                card.querySelector('.item-list').classList.toggle('open');
                card.querySelector('span').classList.toggle('rotate-180');
            }

            if (action === 'add') {
                const nameInput = card.querySelector('input[data-input="name"]');
                const typeInput = card.querySelector('input[data-input="type"]');
                const name = nameInput.value.trim();
                const type = typeInput.value.trim() || 'å…¶ä»–'; // Default type if empty

                if (name) {
                    appData[currentCategory][city][locationIndex].items.push({ name, type, checked: false });
                    saveData();
                    renderCards();
                    // Re-open the card that was just added to
                    setTimeout(() => {
                        const newCard = document.querySelector(`[data-city='${city}'][data-index='${locationIndex}']`);
                        if (newCard) {
                            newCard.querySelector('.item-list').classList.add('open');
                            newCard.querySelector('span').classList.add('rotate-180');
                        }
                    }, 0);
                    createOrUpdateCharts(); // Update charts after adding new item
                }
            }

            const listItem = target.closest('.checklist-item');
            if (listItem) {
                const itemIndex = parseInt(listItem.dataset.itemIndex);
                if (action === 'delete') {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ')) {
                        appData[currentCategory][city][locationIndex].items.splice(itemIndex, 1);
                        saveData();
                        renderCards();
                        createOrUpdateCharts();
                    }
                }

                if (action === 'edit') {
                    const item = appData[currentCategory][city][locationIndex].items[itemIndex];
                    const newName = prompt('è«‹è¼¸å…¥æ–°çš„é …ç›®åç¨±ï¼š', item.name);
                    if (newName && newName.trim() !== '') {
                        item.name = newName.trim();
                        saveData();
                        renderCards();
                    }
                }
            }
        });
        
        itemGrid.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const card = e.target.closest('.location-card');
                const listItem = e.target.closest('.checklist-item');
                if (card && listItem) {
                    const city = card.dataset.city;
                    const locationIndex = parseInt(card.dataset.index);
                    const itemIndex = parseInt(listItem.dataset.itemIndex);
                    appData[currentCategory][city][locationIndex].items[itemIndex].checked = e.target.checked;
                    saveData();
                    // No need to re-render for a checkbox change, just update the style
                    listItem.querySelector('label').classList.toggle('line-through', e.target.checked);
                    listItem.querySelector('label').classList.toggle('text-gray-400', e.target.checked);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderCards();
            createOrUpdateCharts();
            initializeMap();
        });

    </script>
</body>
</html>